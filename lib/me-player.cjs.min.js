"use strict";var e,t=(e=require("Aliplayer"))&&"object"==typeof e&&"default"in e?e.default:e;function i(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}var r=Object.assign,a=function(e){return null==e||""===e},n=function(){function e(){var i=this,n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[],o=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};if(function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),void 0===(this instanceof e?this.constructor:void 0)||(this instanceof e?this.constructor:void 0)!==e)throw new Error("MePlayer \u5fc5\u987b\u5b9e\u4f8b\u5316\u3002");this.config=r({autoplay:!1,step:5,allowSetSpeed:[.5,1,1.25,1.5,2],setSpeed:1,ready:!1,duration:0,currentTime:0,state:0,skinLayout:!1},o),this.instanceMap={},this.availableMap={},this.leader=null,this.eventList={},this.interval=null;for(var l=[],s=function(e){var t=n[e];if(a(t.source))throw new Error("\u64ad\u653e\u5668\u3010 source \u3011\u672a\u6307\u5b9a\u3002");if(a(t.id))throw new Error("\u64ad\u653e\u5668\u3010 id \u3011\u672a\u6307\u5b9a\u3002");if(l.find(function(e){return e===t.id}))throw new Error("\u64ad\u53d1\u5668\u3010 id \u3011 \u4e0d\u80fd\u91cd\u590d\u3002");l.push(t.id),n[e]=r({id:"",source:"",width:"100%",height:"100%",autoplay:!1,isLive:!1,rePlay:!1,playsinline:!0,preload:!0,controlBarVisibility:"always",waitingTimeout:30,useH5Prism:!0},{skinLayout:i.config.skinLayout},t)},u=0;u<n.length;u++)s(u);var c=0,f=function(){++c<n.length||i.leader.duration<=0||(i.config.ready=!0,i.emit("ready",i.config),i.emit("init",i.config),i.emit("state",i.config),i.config.autoplay&&(i.play(),i.emit("play",i.config)))},h=!0,d=!1,v=void 0;try{for(var y,p=function(){var e=y.value,r=e.id,a={player:null,state:0,duration:0,currentTime:0};a.player=new t(e),a.player.on("ready",function(e){a.state=1;var t=a.player.getDuration();a.duration=/\d/.test(t)?t:0,a.duration>0&&(i.availableMap["player:".concat(r)]=a),a.duration>i.config.duration&&(i.config.duration=t,i.leader=a),f()}),a.player.on("error",function(e){console.error("".concat(r," \u9519\u8bef"),e),a.state=2;e.paramData.error_code;f()}),i.instanceMap["player:".concat(r)]=a},g=n[Symbol.iterator]();!(h=(y=g.next()).done);h=!0)p()}catch(e){d=!0,v=e}finally{try{h||null==g.return||g.return()}finally{if(d)throw v}}this.list=n}var n,o,l;return n=e,(o=[{key:"on",value:function(e,t){void 0!==t&&t instanceof Function&&(this.eventList[e]||(this.eventList[e]=[]),this.eventList[e].push(t))}},{key:"emit",value:function(e,t){var i=this.eventList[e];if(i&&!(i.length<=0)){var r=!0,a=!1,n=void 0;try{for(var o,l=i[Symbol.iterator]();!(r=(o=l.next()).done);r=!0){(0,o.value)(t)}}catch(e){a=!0,n=e}finally{try{r||null==l.return||l.return()}finally{if(a)throw n}}}}},{key:"isReady",value:function(){return this.config.ready&&null!==this.leader}},{key:"monitor",value:function(){var e=this,t=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];if(clearTimeout(this.interval),t){!function t(){var i=e.config;i.currentTime===i.duration&&clearTimeout(e.interval);var r=e.leader.duration,a=e.leader.player.getCurrentTime(),n=a-1.5<=0?0:a-1.5,o=a+1.5>=r?r:a+1.5;e.config.currentTime=a;for(var l=0,s=Object.values(e.availableMap);l<s.length;l++){var u=s[l];if(e.leader!==u){var c=u.player,f=u.duration,h=u.currentTime;if(a>=f)h<f&&(u.currentTime=f,c.seek(f+1));else{var d=c.getCurrentTime();d>=n&&d<=o?u.currentTime=d:(u.currentTime=a>=f?f:a,c.play(),c.seek(u.currentTime))}}}e.emit("monitor",e.config),a>=r?(clearTimeout(e.interval),e.config.state=3,e.emit("complete",e.config),e.emit("state",e.config)):setTimeout(t,500)}()}}},{key:"play",value:function(){if(this.isReady()&&1!==this.config.state){for(var e=this.config.setSpeed,t=this.leader.player.getCurrentTime(),i=0,r=Object.values(this.availableMap);i<r.length;i++){var a=r[i];if(this.leader!==a){var n=a.player,o=a.duration;n.setSpeed(e),t>=o?(n.seek(o+1),a.currentTime=o):(n.play(),n.seek(t))}}this.leader.player.setSpeed(e),this.leader.player.play(),this.monitor(!0),this.config.state=1,this.emit("state",this.config)}}},{key:"pause",value:function(){if(this.isReady()&&2!==this.config.state){this.monitor(!1);for(var e=0,t=Object.values(this.availableMap);e<t.length;e++){t[e].player.pause()}this.config.state=2,this.emit("state",this.config)}}},{key:"seek",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0;if(this.isReady()){for(var t=0,i=Object.values(this.availableMap);t<i.length;t++){var r=i[t],a=r.player,n=r.duration;e>=n?(a.seek(n+1),r.currentTime=n):(1===this.config.state&&a.play(),a.seek(e))}this.config.currentTime=e,this.emit("monitor",this.config)}}},{key:"prev",value:function(){this.prevAndForward(!1)}},{key:"forward",value:function(){this.prevAndForward(!0)}},{key:"prevAndForward",value:function(e){if(this.isReady()){var t=this.leader.duration,i=this.config.step,r=this.leader.player.getCurrentTime(),a=e?r+i>=t?t:r+i:r-i<=0?0:r-i;this.seek(a)}}},{key:"setSpeed",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1;if(this.isReady()){e=this.config.allowSetSpeed.find(function(t){return t==e})?e:1,this.config.setSpeed=e;for(var t=0,i=Object.values(this.availableMap);t<i.length;t++){i[t].player.setSpeed(e)}}}},{key:"dispose",value:function(){this.config.ready=!1,clearTimeout(this.interval);for(var e=0,t=Object.values(this.instanceMap);e<t.length;e++){t[e].player.dispose()}}}])&&i(n.prototype,o),l&&i(n,l),e}();module.exports=n;